#!<%= node[:languages][:ruby][:ruby_bin] %>

chef_server_version = File.readlines('/opt/chef-server/version-manifest.txt').detect{|l|l.include?('version-manifest')}.split.last

file = File.join( 
         <%= node[:chef_server_populator][:backup][:dir].inspect %>,
         [ Time.now.to_i,
           "ver_#{chef_server_version}",
           <%= node[:chef_server_populator][:backup][:file].inspect %> ].join("-") 
         )

backup = system("/opt/chef-server/embedded/bin/pg_dump opscode_chef --role=opscode-pgsql --data-only --format=custom > #{file}")

if backup
   creds = <%= node[:chef_server_populator][:backup][:remote][:connection].inspect %>
   if(creds)
     require 'fog'
     remote = Fog::Storage.new(creds)
     directory = <%= node[:chef_server_populator][:backup][:remote][:directory].inspect %>
     name = File.basename(file)
     directory.files.create(:key => name, :body => open(file))
     File.delete(file)
   end
else
   $stderr.puts "Chef Server Backup Failed!"
   exit -1
end
